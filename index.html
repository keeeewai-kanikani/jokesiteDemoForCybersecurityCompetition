<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>System Error</title>

  <!-- Local WindowManager CSS (XP Style for virus look) -->
  <link rel="stylesheet" href="window_manager_library-main/window_common.css">
  <link rel="stylesheet" href="window_manager_library-main/window_xp.css">

  <style>
    body {
      margin: 0;
      background: #0000AA;
      /* Blue Screen color base */
      overflow: hidden;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      cursor: wait;
    }

    #window_container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
    }

    /* Start Overlay - Friendly Design */
    #start_overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #ffffff;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #333;
      font-family: 'Segoe UI', sans-serif;
      cursor: default;
    }

    #start_btn {
      padding: 15px 40px;
      font-size: 18px;
      background-color: #0078d4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: wait;
      transition: background-color 0.2s;
      margin-top: 20px;
      outline: none;
      opacity: 0.5;
    }

    #start_btn:hover {
      background-color: #005a9e;
    }

    #start_btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    h1.welcome-title {
      font-weight: 300;
      font-size: 32px;
      margin-bottom: 10px;
    }

    p.welcome-text {
      font-size: 16px;
      color: #666;
    }

    /* Cracker Animation */
    #cracker_gif {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10000;
      pointer-events: none;
      max-width: 80vw;
      max-height: 80vh;
    }

    /* Glitch Overlay (Phase 3) */
    #glitch_overlay {
      display: none;
      /* Changed: ensure it IS hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      z-index: 20000;
      overflow: hidden;
      pointer-events: none;

      /* Flex properties for when it becomes visible */
      align-items: center;
      justify-content: center;
    }

    /* Skull Emoji */
    .skull-emoji {
      font-size: 15vw;
      /* Large fluid size */
      display: none;
      /* Hidden by default, shown during glitch phase */
    }

    /* BSOD Screen (Phase 4) */
    #bsod_screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #0078d7;
      /* Modern BSOD blue or sticking to #0000AA */
      color: white;
      z-index: 30000;
      padding: 10%;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .bsod-face {
      font-size: 100px;
      margin-bottom: 20px;
    }

    .bsod-title {
      font-size: 32px;
      margin-bottom: 20px;
    }

    .bsod-text {
      font-size: 18px;
      line-height: 1.5;
    }
  </style>
</head>

<body>

  <!-- Phase 1: Start Overlay -->
  <!-- Remove ontouchstart to rely on click (which works everywhere) -->
  <div id="start_overlay">
    <h1 class="welcome-title">Welcome</h1>
    <p class="welcome-text">Click the button below to enter the site.</p>
    <button id="start_btn" onclick="startDemo()" disabled>Downloading Resources...</button>
  </div>

  <!-- Cracker Image -->
  <img id="cracker_gif" src="cracker.gif" alt="Cracker Animation">

  <!-- Phase 2: Window Container -->
  <div id="window_container"></div>

  <!-- Phase 3: Glitch Overlay -->
  <div id="glitch_overlay">
    <div class="skull-emoji">üíÄ</div>
  </div>

  <!-- Phase 4: BSOD -->
  <div id="bsod_screen">
    <div class="bsod-face">:(</div>
    <div class="bsod-title">Error</div>
    <div class="bsod-text">To reinstate, please transfer the payment to the designated account.</div>
  </div>

  <!-- Window Template -->
  <template id="window_template">
    <div class="win" style="width: 100px; height: 75px;">
      <nav class="win-titlebar win-drag-handle">
        <span class="win-icon">‚ö†Ô∏è</span>
        <span class="win-title win-drag-handle">System Warning</span>
        <button class="win-btn win-btn-minimize" onclick="wm.minimize_window(this.closest('.win'))">_</button>
        <button class="win-btn win-btn-restore hidden" onclick="wm.restore_window(this.closest('.win'))">‚ñ°</button>
        <button class="win-btn win-btn-maximize" onclick="wm.maximize_window(this.closest('.win'))">‚ñ°</button>
        <button class="win-btn win-btn-close" onclick="wm.remove_window(this.closest('.win'))">√ó</button>
      </nav>
      <iframe class="win-iframe"></iframe>
      <div class="win-resize-handle"></div>
    </div>
  </template>

  <!-- WindowManager JS -->
  <script src="window_manager_library-main/WindowManager.js"></script>

  <script>
    // --- Window Manager Setup ---
    const wm = new WindowManager(document.getElementById("window_container"), document.getElementById("window_template"), false);
    wm.register_mouse_events(window);
    wm.register_message_events();
    wm.window_snapping = false;

    // --- Content Generators ---
    function createWarningContent(text) {
      const html = `
            <!DOCTYPE html>
            <html>
            <head>
                <style>
                    body { background-color: #f0f0f0; color: black; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; font-family: sans-serif; text-align: center; }
                    h1 { color: red; font-size: 24px; margin: 0; }
                    p { font-size: 14px; }
                    .icon { font-size: 48px; margin-bottom: 10px; }
                    button { margin-top: 10px; padding: 5px 15px; }
                </style>
            </head>
            <body>
                <div class="icon">‚ùå</div>
                <h1>ERROR</h1>
                <p>${text}</p>
                <button onclick="parent.postMessage({command:'close'}, '*')">OK</button>
            </body>
            </html>`;
      return 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
    }

    const messages = [
      "System files corrupted!", "Virus detected in C:/System32", "Unauthorized access attempt!", "Deleting hard drive...",
      "Keyboard not found. Press F1 to continue.", "Your computer is affected by critical vulnerabilities.", "Fatal Exception 0xE0000000", "Memory Overflow!"
    ];

    // --- Web Audio API Setup ---
    let audioCtx;
    const buffers = {};

    // Resource map
    // Resource map
    // We encode ALL filenames to ensure safe fetching on Linux/Unix servers (GitHub Pages)
    const audioResources = [
      { key: 'err', url: encodeURIComponent('„Ç®„É©„Éº„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó.mp3') },
      { key: 'cracker', url: encodeURIComponent('„ÇØ„É©„ÉÉ„Ç´„Éº.mp3') },
      { key: 'glitch', url: encodeURIComponent('ÊúÄÁµÇÁîªÈù¢.mp3') },
      { key: 'bsod', url: encodeURIComponent('„Éñ„É´„Çπ„ÇØ.mp3') }
    ];

    // Helper: Play a buffer
    function playSound(bufferKey, loop = false) {
      if (!audioCtx || !buffers[bufferKey]) return null;

      const source = audioCtx.createBufferSource();
      source.buffer = buffers[bufferKey];
      source.connect(audioCtx.destination);
      source.loop = loop;
      source.start(0);
      return source;
    }

    // Global Unlocker for Mobile Safari / Audio Policies
    function unlockAudio() {
      if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          // Remove listeners once resumed
          ['click', 'touchstart', 'touchend', 'pointerdown'].forEach(event => {
            document.removeEventListener(event, unlockAudio);
          });
        }).catch(e => console.error("Unlock failed", e));
      }
    }

    async function initAudio() {
      console.log("Starting resource download (Web Audio API)...");
      const startBtn = document.getElementById('start_btn');

      // Setup AudioContext (safely)
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AudioContext();

      // Add aggressive unlock listeners
      ['click', 'touchstart', 'touchend', 'pointerdown'].forEach(event => {
        document.addEventListener(event, unlockAudio, { once: false });
      });

      try {
        const promises = audioResources.map(async (res) => {
          const response = await fetch(res.url);
          if (!response.ok) throw new Error(`Failed to load ${res.url}`);
          const arrayBuffer = await response.arrayBuffer();
          const decodedBuffer = await audioCtx.decodeAudioData(arrayBuffer);
          buffers[res.key] = decodedBuffer;
        });

        await Promise.all(promises);
        console.log("All audio resources loaded and decoded.");

        // Enable Button
        if (startBtn) {
          startBtn.innerText = "Enter Site";
          startBtn.disabled = false;
          startBtn.style.opacity = "1";
          startBtn.style.cursor = "pointer";
        }
      } catch (e) {
        console.error("Critical resource load failed:", e);
        if (startBtn) {
          startBtn.innerText = "Load Error (Refresh Page)";
          startBtn.style.background = "#d9534f"; // Red
          startBtn.style.color = "white";
        }
      }
    }

    // Start loading immediately
    initAudio();

    // --- Variables ---
    let count = 0;
    const maxWindows = 20;

    // Extracted from ÂèçËª¢.mid (Assuming 120BPM)
    const glitchIntervals = [
      { start: 3250, end: 3500 },
      { start: 5000, end: 5125 },
      { start: 6500, end: 6625 },
      { start: 7000, end: 10000 }
    ];

    // --- Main Logic ---

    function spawnWindow(index) {
      const baseW = 200;
      const baseH = 150;
      const w = Math.min(baseW, window.innerWidth * 0.8);
      const h = Math.min(baseH, window.innerHeight * 0.4);
      let x, y;

      if (index <= 8) {
        const step = 30; // pixels per step
        const startX = 20;
        const startY = 20;
        x = startX + (index - 1) * step;
        y = startY + (index - 1) * step;
      } else {
        x = Math.random() * (window.innerWidth - w);
        y = Math.random() * (window.innerHeight - h);
      }

      const msg = messages[Math.floor(Math.random() * messages.length)];
      const win = wm.add_window(createWarningContent(msg));
      win.style.left = x + "px";
      win.style.top = y + "px";
      win.style.width = w + "px";
      win.style.height = h + "px";
      win.style.zIndex = 1000 + index;
      win.querySelector('.win-title').innerText = "System Warning #" + index;

      // Play Error Sound
      playSound('err');
    }

    // Prevent double firing if touch and click both happen
    let demoStarted = false;

    async function startDemo() {
      if (demoStarted) return;
      demoStarted = true;

      const overlay = document.getElementById('start_overlay');
      const startBtn = document.getElementById('start_btn');
      const overlayContent = overlay.querySelectorAll('h1, p, button');

      // 0. Resume Audio Context (Critical for Mobile)
      if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume().catch(e => console.error("Audio resume failed:", e));
      }

      // 1. UI Feedback
      if (startBtn) {
        startBtn.innerHTML = "Processing...";
        startBtn.style.cursor = "wait";
      }

      // 2. Hide text
      if (overlayContent) {
        overlayContent.forEach(el => el.style.display = 'none');
      }

      // 3. Play Cracker (Scheduled slightly in future or immediately)
      // Visual sync delay
      setTimeout(() => {
        playSound('cracker');
      }, 300);

      // 4. Show GIF
      const anim = document.getElementById('cracker_gif');
      if (anim) anim.style.display = 'block';

      // 5. Wait for Phase 2 (Chaos)
      setTimeout(() => {
        if (anim) anim.style.display = 'none';
        overlay.style.display = 'none';

        // Start Chaos
        const interval = setInterval(() => {
          if (count >= maxWindows) {
            clearInterval(interval);
            setTimeout(startGlitchPhase, 2000);
            return;
          }
          spawnWindow(count + 1);
          count++;
        }, 200);

      }, 1800);
    }

    function startGlitchPhase() {
      console.log("Starting Glitch Phase");

      const glitchOverlay = document.getElementById('glitch_overlay');
      const skullHandler = glitchOverlay.querySelector('.skull-emoji');

      glitchOverlay.style.display = 'flex';
      skullHandler.style.display = 'block';

      // Play Sound and track start time for sync
      const glitchSource = playSound('glitch');
      const startTime = audioCtx.currentTime;

      if (!glitchSource) {
        // Fallback if sound failed
        setTimeout(startBSOD, 5000);
        return;
      }

      // Sync visual effects
      function updateGlitch() {
        // Approximate check if sound finished
        if (!buffers['glitch']) return;
        const duration = buffers['glitch'].duration;
        const elapsed = audioCtx.currentTime - startTime;

        if (elapsed > duration) {
          // Sound ended
          startBSOD();
          return;
        }

        requestAnimationFrame(updateGlitch);

        const currentTimeMs = elapsed * 1000;

        // Check active interval
        const isActive = glitchIntervals.some(interval =>
          currentTimeMs >= interval.start && currentTimeMs <= interval.end
        );

        if (isActive) {
          glitchOverlay.style.filter = 'invert(1)';
          const rx = (Math.random() - 0.5) * 40;
          const ry = (Math.random() - 0.5) * 40;
          glitchOverlay.style.transform = `translate(${rx}px, ${ry}px)`;
        } else {
          glitchOverlay.style.filter = 'none';
          glitchOverlay.style.transform = 'none';
        }
      }
      updateGlitch();
    }

    function startBSOD() {
      console.log("Starting BSOD Phase");
      const bsod = document.getElementById('bsod_screen');
      bsod.style.display = 'block';

      document.getElementById('glitch_overlay').style.display = 'none';

      playSound('bsod');
    }

  </script>

</body>

</html>